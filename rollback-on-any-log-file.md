**カレントログファイル以外のログファイル（.4BL）からデータを復元したい**

データの書き込みが不完全な場合，たとえばデータファイルの書き込み中にアプリケーションがクラッシュした場合，再起動後に『データファイルが壊れています』というメッセージが表示されます。この場合，ユーザーまたはデータベースの管理者は，次のことをしなければなりません。

1. 最新のバックアップからデータを復元する

2. 最新のログを統合する

これは既定の復帰手順であるため，4Dには，自動復帰のための[データベース設定](http://doc.4d.com/4Dv14/4D/14.3/Configuration-of-backup-settings.300-1705434.ja.html)が用意されています。

* データベースが壊れていたら、最新のバックアップから復元する

* データベースが完全でない場合、最新のログを統合する

運用データベースでは，上記チェックボックスを**両方とも有効**にすることが**強く**推奨されています。有効にされていない場合，データベースは自動的に復元しません。代わりに『データを復元してからログを統合しますか』それとも『MSCでデータを検証しますか』といったダイアログが表示されます。

**注記**: 覚えておきたい点ですが，データファイルの書き込み中にクラッシュした場合，そのデータファイルは，**もう壊れています**。無効なデータの上に有効なデータが部分的に上書きされているためであり，そのようなデータを**修復することはできません**。修復できないものを検証してもあまり得られるものはありません。自動復帰のためのオプションを敢えて有効に**しない**理由があるとすれば，それは開発中のデータベースなど，特殊なケースに限られます。

---

再起動後，復元したデータベースに統合されるのは，クラッシュの直前まで使用されていたカレントログファイルです。必要であれば，データベースの管理者は『[アクティビティ解析](http://doc.4d.com/4Dv14/4D/14.3/Activity-analysis-page.300-1705429.ja.html)』より，オペレーションの内容を確認し，『[ロールバック](http://doc.4d.com/4Dv14/4D/14.3/Rollback-page.300-1705423.ja.html)』を実行することもできます。たとえば，誤ったレコードの削除を取り消すことができます。

ロールバックできるオペレーションは，カレントログファイルに記録されているものに限られます。最新のバックアップよりも昔の状態には戻ることができません。MSCの画面では，最新のバックアップ以外のバックアップファイルを選択することができますが，その場合，『ロールバック』ボタンはグレーアウトされ，クリックできないようになっています。カレントログファイル（.journal）以外のログファイル（.4BL）からロールバックすることは，いまのところ，**MSCではサポートされていない**からです。

とはいえ，**手動ロールバック**を実施すれば，カレントログファイル以外のログファイル（.4BL）までデータをロールバックすることができます。この記事では，その方法を説明しています。

1. カレントログファイル（.journal）
---

* 『ファイル/復元』メニューまたはMSCより，新規フォルダー内に最新のバックアップ（.4BK）を復元します。

 * データファイル（.4DD）以外は削除します。
* カレントデータベースのフォルダーより，下記のファイルとフォルダーを上述のバックアップ復元フォルダーにコピーします。

 * ```Preferences```フォルダー（```backup.xml```が含まれている）
 * ストラクチャファイル（.4DB）
 * 最新のバックアップファイル（.4BKおよび.4BL）
 * カレントログファイル（.journal）
* カレントデータベースフォルダーの名称を変更します。（例：```_old```のように適当な接尾辞を付ける）

* バックアップ復元フォルダーの名称をカレントデータベースフォルダーの元の名称に変更します。

* データベースを起動します。

2. バックアップされたログファイル（.4BL）
---

* ログファイル（.4BL）N番を新規フォルダーに復元します。

* バックアップ（.4BK）N番を『ファイル/復元』メニューまたはMSCより，同じフォルダーに復元します。

 *  データファイル（.4DD）および復元したログファイル（.journal）以外は削除します。

* バックアップN+1番を別の新規フォルダーに復元し，**復元したバックアップN番のフォルダー**に，下記のファイルとフォルダーをコピーします。

 * ```Preferences```フォルダー（```backup.xml```が含まれている）
 * ストラクチャファイル（.4DB）

* バックアップ（.4BK）N番を**復元したバックアップN番のフォルダー**にコピーします。

* バックアップログファイル（.4BL）N-1番を**復元したバックアップN番のフォルダー**にコピーします。

* カレントデータベースフォルダーの名称を変更します。（例：```_old```のように適当な接尾辞を付ける）

* バックアップ復元フォルダーの名称をカレントデータベースフォルダーの元の名称に変更します。

* データベースを起動します。

---
**原文**: [Rollback on any log file](http://taow.4d.com/Rollback-on-any-log-file/tips.56849281.en.html)
